<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pontua√ß√£o de Grupos</title>
  <style>
    :root { --gap: 14px; --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0f172a; color: white; }
    .wrap { max-width: 950px; margin: 24px auto; padding: 20px; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius); padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    h2 { font-size: 16px; margin: 18px 0 8px; opacity: .9; }
    label { display:block; font-size: 14px; opacity:.9; margin-bottom: 6px; }
    input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: #0b1220; color: #e5e7eb; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row2 { display:flex; gap: var(--gap); align-items:center; margin-bottom: 10px; }
    .grid4 { display:grid; grid-template-columns: repeat(4,1fr); gap: var(--gap); }
    .students { display:grid; grid-template-columns: 1fr 120px; gap: 8px 12px; align-items:center; }
    .badge { background:#0b1220; border:1px solid #334155; padding:8px 10px; border-radius:10px; font-variant-numeric: tabular-nums; }
    .btn { background:#22c55e; color:#06220f; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn:hover { filter: brightness(1.05); }
    .muted { opacity:.8; font-size:12px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row2">
        <h1 style="margin:0;">üèÅ Pontua√ß√£o ‚Äì <span id="classLabel"></span></h1>
        <select id="classSelect" style="max-width:280px; margin-left:auto;"></select>
      </div>

      <div class="row">
        <div>
          <label>Selecione o grupo</label>
          <select id="group"></select>
        </div>
        <div>
          <label>Seu nome (opcional)</label>
          <input id="teacher" placeholder="Ex.: Prof. Bruno"/>
        </div>
      </div>

      <h2>Quatro categorias</h2>
      <div class="grid4">
        <div><label>Visual</label><input type="number" id="c1" min="0" step="0.1" /></div>
        <div><label>Trilha Sonora</label><input type="number" id="c2" min="0" step="0.1" /></div>
        <div><label>Proposta</label><input type="number" id="c3" min="0" step="0.1" /></div>
        <div><label>Vocabul√°rio/Roteiro</label><input type="number" id="c4" min="0" step="0.1" /></div>
      </div>

      <h2>Apresenta√ß√£o por aluno</h2>
      <div id="students" class="students"></div>

      <h2>Resumo</h2>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div class="badge">M√©dia 4 categorias: <b id="avgCats">0</b></div>
        <div class="badge">M√©dia apresenta√ß√£o: <b id="avgPres">0</b></div>
        <div class="badge">Pontua√ß√£o da rodada: <b id="finalRound">0</b></div>
      </div>

      <div style="margin-top:16px; display:flex; gap:12px; align-items:center;">
        <button class="btn" id="submit">Salvar pontua√ß√£o</button>
        <span class="muted" id="msg"></span>
      </div>
    </div>
  </div>

<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbxnMV0CRwJIjKOsBvDf0-8sz1520myCx9w0LcnfoYRDpHWS1-bJpSIkVW5ZjCulZVQ7vQ/exec';

function jsonp(url){
  return new Promise((resolve, reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
    s.onerror = () => { delete window[cb]; reject(new Error('Falha JSONP')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}
function el(id){ return document.getElementById(id); }
function n(v){ const x = parseFloat(v); return isNaN(x) ? 0 : x; }
function round2(x){ return Math.round(x*100)/100; }

let CURRENT_CLASS = null;
let GROUPS = [];

function compute(){
  const avgCats = (n(el('c1').value)+n(el('c2').value)+n(el('c3').value)+n(el('c4').value))/4;
  const presInputs = document.querySelectorAll('[data-pres]');
  const presVals = Array.from(presInputs).map(i=>n(i.value)).filter(v=>!Number.isNaN(v) && v!==0);
  const avgPres = presVals.length ? presVals.reduce((a,b)=>a+b,0)/presVals.length : 0;
  el('avgCats').textContent = round2(avgCats);
  el('avgPres').textContent = round2(avgPres);
  el('finalRound').textContent = round2(avgCats + avgPres);
}

function renderStudents(group){
  const box = el('students'); box.innerHTML = '';
  (group?.members||[]).forEach(name => {
    const rowName = document.createElement('div'); rowName.textContent = name;
    const rowInput = document.createElement('input');
    rowInput.type = 'number'; rowInput.step = '0.1'; rowInput.min='0';
    rowInput.dataset.pres='1'; rowInput.placeholder='Apresenta√ß√£o';
    rowInput.addEventListener('input', compute);
    box.appendChild(rowName); box.appendChild(rowInput);
  });
}

async function loadClasses(){
  el('msg').textContent = 'Carregando turmas...';
  const data = await jsonp(`${API_BASE}?route=classes`);
  const classes = data.classes || [];
  const sel = el('classSelect'); sel.innerHTML = '';
  classes.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  const urlClass = new URLSearchParams(location.search).get('class');
  const saved = localStorage.getItem('selectedClass');
  CURRENT_CLASS = urlClass || saved || data.defaultClass || classes[0] || '1 Ano A';
  if (classes.includes(CURRENT_CLASS)) sel.value = CURRENT_CLASS;
  else { sel.value = classes[0]; CURRENT_CLASS = classes[0]; }
  el('classLabel').textContent = CURRENT_CLASS;
  el('msg').textContent = '';
}

async function loadGroups(){
  try{
    const data = await jsonp(`${API_BASE}?route=groups&class=${encodeURIComponent(CURRENT_CLASS)}`);
    GROUPS = data.groups||[];
    const sel = el('group'); sel.innerHTML='';
    GROUPS.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; sel.appendChild(o); });
    sel.onchange = ()=>{ const g = GROUPS.find(x=>x.id===sel.value); renderStudents(g); compute(); };
    if (GROUPS[0]){ sel.value = GROUPS[0].id; renderStudents(GROUPS[0]); } else { renderStudents({members:[]}); }
    ['c1','c2','c3','c4'].forEach(id=> el(id).addEventListener('input', compute));
    const savedName = localStorage.getItem('teacherName'); if (savedName) el('teacher').value = savedName;
    el('teacher').addEventListener('change', ()=> localStorage.setItem('teacherName', el('teacher').value));
    compute();
    el('msg').textContent = GROUPS.length ? '' : 'Sem grupos para esta turma.';
  }catch(err){
    el('msg').textContent = `Erro ao carregar grupos: ${err.message}`;
  }
}

async function submit(){
  const sel = el('group');
  const groupId = sel.value;
  const categories = ['c1','c2','c3','c4'].map(id => n(el(id).value));
  const presentations = Array.from(document.querySelectorAll('#students input'))
    .map((inp, idx) => ({ student: el('students').children[idx*2].textContent, score: n(inp.value) }))
    .filter(p => p.score>0);

  const url = `${API_BASE}?route=submitScore`
    + `&class=${encodeURIComponent(CURRENT_CLASS)}`
    + `&groupId=${encodeURIComponent(groupId)}`
    + `&c1=${categories[0]}&c2=${categories[1]}&c3=${categories[2]}&c4=${categories[3]}`
    + `&submittedBy=${encodeURIComponent(el('teacher').value||'')}`
    + `&presentations=${encodeURIComponent(JSON.stringify(presentations))}`;

  try{
    const data = await jsonp(url);
    el('msg').innerHTML =
      `<span style="color:#22c55e">Salvo! ${CURRENT_CLASS} ‚Äî Rodada = ${data.finalRound.toFixed(2)} (4 cat: ${data.avgCategories.toFixed(2)} / apr: ${data.presentationAvg.toFixed(2)})</span>`;
    document.querySelectorAll('#students input').forEach(i=> i.value='');
    compute();
  }catch(err){
    el('msg').innerHTML = `<span style="color:#ef4444">Falha ao salvar: ${err.message}</span>`;
  }
}

el('submit').addEventListener('click', submit);
el('classSelect').addEventListener('change', async ()=>{
  CURRENT_CLASS = el('classSelect').value;
  localStorage.setItem('selectedClass', CURRENT_CLASS);
  el('classLabel').textContent = CURRENT_CLASS;
  await loadGroups();
});

(async function init(){
  await loadClasses();
  await loadGroups();
})();
</script>
</body>
</html>
