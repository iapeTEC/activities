<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Recep√ß√£o de Perguntas ‚Äî Hist√≥ria da Eletricidade</title>
  <meta name="description" content="Formul√°rio com anti-cola, timer e registro para recep√ß√£o e monitoramento das perguntas." />
  <style>
    :root{--bg:#fff;--card:#fff;--text:#0b1220;--muted:#6b7280;--accent:#1f6feb;--ok:#16a34a;--ok-weak:#dcfce7;--warn:#b45309;--bad:#dc2626;--border:rgba(0,0,0,.12);--shadow:rgba(0,0,0,.08)}
    html[data-theme="dark"]{--bg:#000;--card:#0b0b0f;--text:#f5f7ff;--muted:#a3a7b7;--accent:#7c9bff;--ok:#22c55e;--ok-weak:#062b14;--warn:#ffb02e;--bad:#ff6b6b;--border:rgba(255,255,255,.14);--shadow:rgba(0,0,0,.55)}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:saturate(1.1) blur(8px);border-bottom:1px solid var(--border)}
    html[data-theme="dark"] header{background:rgba(0,0,0,.7)}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    h1{margin:0 0 6px;font-size:clamp(22px,2.6vw,32px)} .sub{color:var(--muted)}
    .bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-top:10px}
    input[type=text]{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;min-width:220px;outline:none}
    input[type=text]::placeholder{color:var(--muted)} button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px var(--shadow)}
    button[disabled]{opacity:.5;cursor:not-allowed} .icon-btn{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);padding:8px 12px;border-radius:999px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:880px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:0 8px 30px var(--shadow)}
    .card h3{margin:0 0 6px;font-size:18px} .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;font-size:12px}
    .small{font-size:12px}
    .writing{min-height:110px;width:100%;resize:vertical;background:transparent;border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px}
    .range{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-top:8px}
    .strike{opacity:.6;filter:grayscale(.3)} footer{border-top:1px solid var(--border);margin-top:24px;padding:20px;color:var(--muted)}
    .notice{border:1px dashed var(--border);padding:10px;border-radius:10px;color:var(--muted)}
    .hidden{display:none!important} .timer{font-weight:800;letter-spacing:.5px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);z-index:9998;display:none}
    .toast.show{display:block}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);color:var(--text);width:min(680px,92vw);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 20px 60px var(--shadow)}
    .modal h2{margin:0 0 8px} .modal .rules{background:rgba(0,0,0,.03);border:1px dashed var(--border);padding:12px;border-radius:12px;margin-top:10px}
    .modal footer{display:flex;gap:10px;justify-content:flex-end;border:0;padding:0;margin-top:14px}
    .btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border);box-shadow:none}
  </style>
</head>
<body>
  <!-- Modal -->
  <div id="consentBackdrop" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <h2>Recep√ß√£o de Perguntas</h2>
      <div class="muted">Digite seu <b>nome completo</b> e clique em ‚ÄúAceitar e come√ßar‚Äù. O cron√¥metro iniciar√°.</div>
      <label for="modalName" class="muted" style="display:block;margin:10px 0 6px">Nome completo</label>
      <input id="modalName" type="text" placeholder="Ex.: Maria Fernanda Silva" autocomplete="name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)" />
      <div class="rules">
        <ul>
          <li>Ativaremos <b>tela cheia</b> (se o navegador permitir).</li>
          <li>Trocas de aba/janela s√£o <b>registradas</b>.</li>
          <li><b>Copiar/colar/recortar</b> e <b>Ctrl/Cmd+F</b> s√£o bloqueados.</li>
          <li>Envie ao terminar; caso contr√°rio, o envio √© autom√°tico ao fim do tempo.</li>
        </ul>
      </div>
      <footer>
        <button id="declineBtn" class="btn-ghost">Sair</button>
        <button id="acceptBtn" disabled>Aceitar e come√ßar</button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite">A√ß√£o registrada.</div>

  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Hist√≥ria da Eletricidade ‚Äî Recep√ß√£o de Perguntas</h1>
          <div class="sub">Monitoramento + Anti-cola + CSV</div>
        </div>
        <button id="themeToggle" class="icon-btn">üåì Tema</button>
      </div>
      <div class="bar">
        <div class="row">
          <input id="studentName" type="text" placeholder="Nome (preenche ao aceitar)" autocomplete="name" />
          <span class="pill"><strong>Tempo:</strong> <span id="timer" class="timer">30:00</span></span>
          <span id="focusFlag" class="badge">Foco OK</span>
          <span id="tabCount" class="badge">Abas: 0</span>
        </div>
        <div class="row">
          <input id="testId" type="text" value="Perguntas-Electricidade-v1" />
          <button id="startBtn" class="hidden">Iniciar</button>
          <button id="submitBtn" disabled>Enviar</button>
        </div>
      </div>
      <div class="notice small" id="notes">O envio √© autom√°tico ao final do tempo.</div>
    </div>
  </header>

  <main class="wrap">
    <form id="quizForm" class="grid" autocomplete="off">
      <!-- Cart√µes inseridos via JS -->
    </form>

    <div class="card">
      <h3>Resultados & Admin</h3>
      <p class="muted small">Somente professor.</p>
      <div class="row" style="margin-top:10px">
        <button id="downloadCsvBtn" disabled>Download CSV</button>
        <button id="resetBtn" class="icon-btn">Reset</button>
      </div>
    </div>

    <footer>
      <div class="small">Designed by MF Bruno ‚Äî vers√£o recep√ß√£o de perguntas.</div>
    </footer>
  </main>

  <script>
  // ===== Tema =====
  (function(){
    const root=document.documentElement;
    const saved=localStorage.getItem('theme')||'light';
    root.setAttribute('data-theme',saved);
    document.getElementById('themeToggle').addEventListener('click',()=>{
      const next=root.getAttribute('data-theme')==='light'?'dark':'light';
      root.setAttribute('data-theme',next); localStorage.setItem('theme',next);
    });
  })();

  // ===== Perguntas =====
  const QUESTIONS = [
  { name: "Adriely Samara Chagas de Souza Silva", prompt: "(Adriely Samara Chagas de Souza Silva) How do cultural traditions shape the way people interact in different societies?", suggested: 9 },

  { name: "Allyson Henrique Gomes da Silva", prompt: "(Allyson Henrique Gomes da Silva) Can the culture of other countries influence your personal values?", suggested: 9 },

  { name: "√Ålvaro Rodrigues Silvestre da Silva", prompt: "(√Ålvaro Rodrigues Silvestre da Silva) ‚Äî (no question provided)", suggested: 0 },
  { name: "B√°rbara Dayalle Flor√™ncio da Silva", prompt: "(B√°rbara Dayalle Flor√™ncio da Silva) ‚Äî (no question provided)", suggested: 0 },

  { name: "Camile Renata da Silva", prompt: "(Camile Renata da Silva) What are your family norms?", suggested: 8 },

  { name: "Isabelly Alves da Silva Melo", prompt: "(Isabelly Alves da Silva Melo) How does globalization influence local cultures?", suggested: 9 },

  { name: "Carlos Daniel Barros do Amaral", prompt: "(Carlos Daniel Barros do Amaral) Which cultural customs intrigue you the most, and why?", suggested: 8 },

  { name: "Danyella Farias Ribeiro", prompt: "(Danyella Farias Ribeiro) What values do you admire most in a culture?", suggested: 8 },

  { name: "Davi Albuquerque de Oliveira", prompt: "(Davi Albuquerque de Oliveira) What is the most beautiful aspect of a culture, in your view?", suggested: 8 },

  { name: "D√©bora Valentina Santos Lima", prompt: "(D√©bora Valentina Santos Lima) Which cultures do you like the most, and why?", suggested: 8 },

  { name: "Eduardo Victor Gomes de Santana", prompt: "(Eduardo Victor Gomes de Santana) ‚Äî (no question provided)", suggested: 0 },

  { name: "Ellen Gabriella Rodrigues de Melo", prompt: "(Ellen Gabriella Rodrigues de Melo) How do your personal values influence your choices within the culture you live in?", suggested: 9 },

  { name: "Evelyn Medeiros Martins", prompt: "(Evelyn Medeiros Martins) Which parts of a culture do you like the most, and why?", suggested: 8 },

  { name: "Fernanda Evelyn da C√¢mara Lima", prompt: "(Fernanda Evelyn da C√¢mara Lima) Do you have descendants from other cultures in your family?", suggested: 7 },

  { name: "Giovanna Laila Lima de Albuquerque Nobre", prompt: "(Giovanna Laila Lima de Albuquerque Nobre) Do you think different cultures can live together harmoniously?", suggested: 8 },

  { name: "Ivy Rakelly Siqueira de Azevedo", prompt: "(Ivy Rakelly Siqueira de Azevedo) ‚Äî (no question provided)", suggested: 0 },

  { name: "Jo√£o Jos√© da Silva Neto", prompt: "(Jo√£o Jos√© da Silva Neto) Are there any uncommon beliefs in your family?", suggested: 7 },

  { name: "Jo√£o Weslley Dionizzio Mendes", prompt: "(Jo√£o Weslley Dionizzio Mendes) ‚Äî (no question provided)", suggested: 0 },

  { name: "Xandriely (ajustar sobrenome no dia)", prompt: "(Xandriely) ‚Äî (no question provided)", suggested: 0 },

  { name: "Jonata Bezerra da Silva", prompt: "(Jonata Bezerra da Silva) How has the internet transformed the way cultures are shared and consumed around the world?", suggested: 9 },

  { name: "J√∫lia Evelyn Lopes da Silva", prompt: "(J√∫lia Evelyn Lopes da Silva) What are symbols, and how do they work within a culture?", suggested: 8 },

  { name: "Kau√£ Rafael Sales Santos", prompt: "(Kau√£ Rafael Sales Santos) ‚Äî (no question provided)", suggested: 0 },

  { name: "Larissa Maria da Silva Santos", prompt: "(Larissa Maria da Silva Santos) ‚Äî (no question provided)", suggested: 0 },

  { name: "Leon de Almeida Brito", prompt: "(Leon de Almeida Brito) ‚Äî (no question provided)", suggested: 0 },

  { name: "Lorena Barbosa de Souza", prompt: "(Lorena Barbosa de Souza) Do you like your culture or another culture more? Why?", suggested: 7 },

  { name: "Lucas Gon√ßalves Tashiro", prompt: "(Lucas Gon√ßalves Tashiro) ‚Äî (no question provided)", suggested: 0 },

  { name: "Luiz Felipe Bastos da Silva Nogueira", prompt: "(Luiz Felipe Bastos da Silva Nogueira) What do ‚Äònorms‚Äô mean to you in a cultural context?", suggested: 8 },

  { name: "Maria Clara Barbosa Arandas", prompt: "(Maria Clara Barbosa Arandas) ‚Äî (no question provided)", suggested: 0 },

  { name: "Maria Eduarda Rodrigues da Silva", prompt: "(Maria Eduarda Rodrigues da Silva) What are ‚Äòvalues‚Äô in a culture, and how are they learned?", suggested: 9 },

  { name: "Maria Isadora Ten√≥rio de Oliveira", prompt: "(Maria Isadora Ten√≥rio de Oliveira) ‚Äî (no question provided)", suggested: 0 },

  { name: "Maria Paula Pereira de Medeiros", prompt: "(Maria Paula Pereira de Medeiros) In your opinion, who defines what counts as a value in a culture?", suggested: 8 },

  { name: "Marina Maria Barbosa Farias", prompt: "(Marina Maria Barbosa Farias) Do you think culture changes over time? Why or why not?", suggested: 9 },

  { name: "Michael Victor Cordeiro dos Santos", prompt: "(Michael Victor Cordeiro dos Santos) How has globalization affected traditional cultures?", suggested: 9 },

  { name: "Miguel Ludgero da Silva Neto", prompt: "(Miguel Ludgero da Silva Neto) What does ‚Äòculture‚Äô mean to you?", suggested: 8 },

  { name: "Paulo Henrique da Silva Santos", prompt: "(Paulo Henrique da Silva Santos) Which culture do you think is the most difficult to follow? Why?", suggested: 7 },

  { name: "Paulo Tashiro Frota", prompt: "(Paulo Tashiro Frota) What are some odd habits or characteristics that exist in your family?", suggested: 7 },

  { name: "Sandrielly La√≠sa dos Santos", prompt: "(Sandrielly La√≠sa dos Santos) ‚Äî (no question provided)", suggested: 0 },

  { name: "Vanessa Viana Alencar", prompt: "(Vanessa Viana Alencar) Which culture in the world do you like most, and why?", suggested: 7 },

  // Victor trouxe duas quest√µes de V/F ‚Äî mantive separadas:
  { name: "Victor Kau√£ de Fran√ßa Soares", prompt: "(Victor Kau√£ de Fran√ßa Soares) True or False: Different cultures have different symbols.", suggested: 8 },
  { name: "Victor Kau√£ de Fran√ßa Soares", prompt: "(Victor Kau√£ de Fran√ßa Soares) True or False: Norms are not defined as ‚Äògood‚Äô or ‚Äòbad‚Äô by themselves.", suggested: 8 },

  { name: "William Souza Donato", prompt: "(William Souza Donato) ‚Äî (no question provided)", suggested: 0 },

  { name: "Yasmim Allana Elias Reis Silva", prompt: "(Yasmim Allana Elias Reis Silva) ‚Äî (no question provided)", suggested: 0 }
];

  // ===== Config =====
  const DEFAULT_MINUTES=30;
  const ENDPOINT='https://script.google.com/macros/s/AKfycbzWovrGHidKrd0HCXmH5BgGn-7_D-T_-VhWQ1IKXh68W1cvp4Q1s9d8WVLckKvy5fn96g/exec';

  // ===== Estado =====
  let started=false, ended=false;
  let startTime=null, endTime=null, timerInterval=null;
  let secondsLeft = DEFAULT_MINUTES*60;

  // Anti-cheat
  let tabSwitches=0, blurCount=0, isBlurred=false, blurStart=null, totalBlurMs=0;
  let copyCount=0, pasteCount=0, findCount=0;

  // Offset ap√≥s popup
  let acceptTs=null; const GRACE_MS=2500; let systemPopupOffsetApplied=false;

  // ===== DOM =====
  const startBtn=document.getElementById('startBtn');
  const submitBtn=document.getElementById('submitBtn');
  const timerEl=document.getElementById('timer');
  const form=document.getElementById('quizForm');
  const nameInput=document.getElementById('studentName');
  const testIdInput=document.getElementById('testId');
  const focusFlag=document.getElementById('focusFlag');
  const tabCountEl=document.getElementById('tabCount');
  const downloadCsvBtn=document.getElementById('downloadCsvBtn');
  const resetBtn=document.getElementById('resetBtn');
  const toast=document.getElementById('toast');
  const modalName=document.getElementById('modalName'); const acceptBtnEl=document.getElementById('acceptBtn');
  document.body.style.overflow='hidden';

  // ===== Vers√£o/rascunho por prova =====
  const FORM_VERSION = '2025-10-22'; // mude quando atualizar a prova
  function draftKey(){
    const tid = (testIdInput?.value || 'default').trim();
    return `recepcao_perguntas_${FORM_VERSION}_${tid}`;
  }
  // remove chave legada
  localStorage.removeItem('recepcao_perguntas_draft_v1');

  // ===== Utils =====
  function lockForm(disabled=true){ [...form.elements].forEach(el=>el.disabled=disabled) }
  lockForm(true);

  function showToast(msg){ toast.textContent=msg||'A√ß√£o registrada.'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1500) }
  function fmt(secs){ const m=String(Math.floor(secs/60)).padStart(2,'0'); const s=String(secs%60).padStart(2,'0'); return `${m}:${s}` }
  function tick(){ secondsLeft--; if(secondsLeft<0) secondsLeft=0; timerEl.textContent=fmt(secondsLeft); if(secondsLeft===0) autoSubmit('time') }
  function startTimer(){ clearInterval(timerInterval); timerInterval=setInterval(tick,1000) }
  async function goFullscreen(){ try{ if(!document.fullscreenElement && document.documentElement.requestFullscreen){ await document.documentElement.requestFullscreen(); } }catch(e){} }
  function maybeApplySystemPopupOffset(){
    if(started && !systemPopupOffsetApplied && acceptTs && (Date.now()-acceptTs)<=GRACE_MS){
      tabSwitches=Math.max(0,tabSwitches-1); systemPopupOffsetApplied=true; tabCountEl.textContent=`Abas: ${tabSwitches}`;
    }
  }
  function isValidFullName(n){ const t=(n||'').trim().replace(/\s+/g,' '); const parts=t.split(' ').filter(p=>p.length>=2); return parts.length>=2 }

  // ===== Render cards =====
  function renderCards(){
    const frag=document.createDocumentFragment();
    QUESTIONS.forEach((q,i)=>{
      const sec=document.createElement('section');
      sec.className='card'; sec.dataset.index=i;
      sec.innerHTML=`
        <h3>${q.prompt}</h3>
        <div class="muted small">Escreva sua resposta (pontos principais, datas, nomes, conceitos).</div>
        <textarea class="writing" name="ans_${i}" placeholder="Digite aqui..."></textarea>
        <div class="range">
          <label class="small muted">Nota (0‚Äì10): <output id="out_${i}">${q.suggested??0}</output></label>
          <input type="range" min="0" max="10" step="1" value="${q.suggested??0}" name="score_${i}" aria-label="Nota para ${q.name}" />
        </div>
        <div class="small muted" id="status_${i}" aria-live="polite">Status: aguardando‚Ä¶</div>
      `;
      frag.appendChild(sec);
    });
    form.appendChild(frag);

    // binds
    QUESTIONS.forEach((_,i)=>{
      const rng=form.querySelector(`[name=score_${i}]`);
      const out=document.getElementById(`out_${i}`);
      const ta=form.querySelector(`[name=ans_${i}]`);
      const st=document.getElementById(`status_${i}`);
      rng.addEventListener('input',()=>{ out.textContent=rng.value; st.textContent='Status: em edi√ß√£o'; });
      ta.addEventListener('input',()=>{ st.textContent= ta.value.trim()? 'Status: entregue (rascunho salvo localmente)' : 'Status: aguardando‚Ä¶'; saveDraft(); });
    });
  }
  renderCards();

  // ===== Draft local =====
  function saveDraft(){
    if(!started) return;
    const data = collectAnswersOnly();
    localStorage.setItem(draftKey(), JSON.stringify({
      testId: testIdInput.value,
      name: nameInput.value,
      data
    }));
  }

  function loadDraft(){
    try{
      const raw=localStorage.getItem(draftKey()); if(!raw) return;
      const {testId,name,data}=JSON.parse(raw||'{}');

      const sameTest = (testId||'').trim() === (testIdInput.value||'').trim();
      const sameName = (name||'').trim() === (nameInput.value||'').trim();
      if(!(sameTest && sameName)) return; // s√≥ carrega se for mesma pessoa e mesma prova

      (data||[]).forEach((row,i)=>{
        const ta=form.querySelector(`[name=ans_${i}]`);
        const rng=form.querySelector(`[name=score_${i}]`);
        const out=document.getElementById(`out_${i}`);
        const st=document.getElementById(`status_${i}`);
        if(ta) ta.value=row.answer||'';
        if(rng){ rng.value=row.score??0; if(out) out.textContent=rng.value; }
        if(st) st.textContent = (row.answer||'').trim()
          ? 'Status: entregue (rascunho salvo localmente)'
          : 'Status: aguardando‚Ä¶';
      });
    }catch(e){}
  }

  // ===== Coleta =====
  function collectAnswersOnly(){
    return QUESTIONS.map((q,i)=>{
      const ans=form.querySelector(`[name=ans_${i}]`)?.value||'';
      const score=Number(form.querySelector(`[name=score_${i}]`)?.value||0);
      return { name:q.name, prompt:q.prompt, answer:ans.trim(), score };
    });
  }

  // >>> Payload compat√≠vel com script antigo <<<
  function collectPayload(reason='manual'){
    const rows = collectAnswersOnly();
    const now = new Date();
    const studentNameSafe = (nameInput.value || '').trim() || '(no name)';

    const answers = {};
    const writing = {};
    rows.forEach((r, idx) => {
      const key = 'q' + (idx + 1);
      writing[key] = { prompt: r.prompt, answer: r.answer, score: r.score };
    });

    const total = rows.length;
    const sumScore = rows.reduce((a,c)=> a + (Number(c.score)||0), 0);
    const avgScore = total ? (sumScore/total) : 0;

    return {
      testId: (testIdInput.value.trim() || 'Perguntas-Electricidade-v1'),
      studentName: studentNameSafe,
      startISO: startTime?.toISOString() || null,
      endISO: now.toISOString(),
      durationSec: startTime ? Math.round((now - startTime)/1000) : null,
      reason,
      score: {
        totalCorrect: 0,
        totalPossible: 0,
        byDifficulty: { easy:0, medium:0, hard:0 },
        possibleByDifficulty: { easy:0, medium:0, hard:0 },
        filled: rows.filter(r=>r.answer.length>0).length,
        average: avgScore
      },
      answers,
      writing,
      focus: { tabSwitches, blurCount, totalBlurMs, copyCount, pasteCount, findCount }
    };
  }

  // >>> CSV compat√≠vel com o original <<<
  function toCSV(payload){
    const header = [
      'timestamp','testId','studentName','startISO','endISO','durationSec',
      'correct','possible','easyCorrect','mediumCorrect','hardCorrect',
      'tabSwitches','blurCount','totalBlurMs','copyCount','pasteCount','findCount',
      'answers','writing'
    ];
    const row = [
      new Date().toISOString(),
      payload.testId,
      JSON.stringify(payload.studentName),
      payload.startISO,
      payload.endISO,
      payload.durationSec,
      payload.score.totalCorrect,
      payload.score.totalPossible,
      payload.score.byDifficulty.easy,
      payload.score.byDifficulty.medium,
      payload.score.byDifficulty.hard,
      payload.focus.tabSwitches,
      payload.focus.blurCount,
      payload.focus.totalBlurMs,
      payload.focus.copyCount,
      payload.focus.pasteCount,
      payload.focus.findCount,
      JSON.stringify(payload.answers),
      JSON.stringify(payload.writing)
    ];
    return header.join(',') + '\n' + row.join(',');
  }

  async function sendResults(payload){
    try{
      const res=await fetch(ENDPOINT,{ method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify(payload) });
      return { posted:res.ok, status:res.status };
    }catch(err){ console.warn('POST failed',err); return { posted:false, error:String(err) } }
  }

  function downloadCSV(name, csv){
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`${(name||'anonymous').replace(/\s+/g,'_')}_Perguntas_Electricidade.csv`; document.body.appendChild(a); a.click(); a.remove();
  }

  function lockTest(){
    lockForm(true); submitBtn.disabled=true; downloadCsvBtn.disabled=false;
    document.getElementById('notes').textContent='Locked. Respostas registradas.';
    document.querySelectorAll('section.card').forEach(sec=>sec.classList.add('strike'));
  }

  async function finalize(reason){
    if(ended) return; ended=true; endTime=new Date(); clearInterval(timerInterval);
    const payload=collectPayload(reason);
    const csv=toCSV(payload);
    const postRes=await sendResults(payload);
    downloadCSV(payload.studentName||'anonymous', csv);
    lockTest();
    try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
    console.log('Payload:', payload, 'POST:', postRes);
  }
  function autoSubmit(reason){ finalize(reason) }

  // ===== Eventos principais =====
  function startTest(){
    started=true; startTime=new Date();
    nameInput.disabled=true; testIdInput.disabled=true;
    startBtn.disabled=true; startBtn.classList.add('hidden'); submitBtn.disabled=false;
    lockForm(false); setTimeout(()=>lockForm(false),0);
    startTimer();
    document.addEventListener('copy',(e)=>{copyCount++; e.preventDefault(); showToast('C√≥pia bloqueada.')});
    document.addEventListener('cut',(e)=>{e.preventDefault(); showToast('Recorte bloqueado.')});
    document.addEventListener('paste',(e)=>{pasteCount++; e.preventDefault(); showToast('Colagem bloqueada.')});
    document.addEventListener('keydown',(e)=>{
      const k=e.key.toLowerCase(); const ctrl=e.ctrlKey||e.metaKey;
      if(ctrl&&(k==='c'||k==='v'||k==='x'||k==='s'||k==='p'||k==='f')){ e.preventDefault(); showToast('Atalho bloqueado.'); if(k==='f') findCount++; }
      if(k==='f11'){ e.preventDefault(); showToast('F11 bloqueado.'); }
    },{capture:true});
    document.addEventListener('contextmenu',(e)=> e.preventDefault());
    document.addEventListener('fullscreenchange',()=>{ /* n√£o re-for√ßa */ });
    // n√£o carrega aqui: s√≥ depois que o nome foi setado (no aceitar)
  }

  startBtn.addEventListener('click', startTest);
  submitBtn.addEventListener('click', ()=> finalize('manual'));

  downloadCsvBtn.addEventListener('click', ()=>{
    const csv=toCSV(collectPayload('download-only'));
    downloadCSV((nameInput.value||'').trim()||'anonymous', csv);
  });

  // RESET CORRIGIDO
  resetBtn.addEventListener('click', ()=>{
    try{
      localStorage.removeItem(draftKey());                 // apaga rascunho desta prova/vers√£o
      localStorage.removeItem('recepcao_perguntas_draft_v1'); // apaga legado
    }catch(e){}
    location.reload();
  });

  // ===== Anti-cheat =====
  document.addEventListener('visibilitychange', ()=>{
    if(!started||ended) return;
    if(document.visibilityState==='hidden'){
      tabSwitches++; tabCountEl.textContent=`Abas: ${tabSwitches}`;
      focusFlag.textContent='Focus LOST'; isBlurred=true; blurStart=Date.now();
      maybeApplySystemPopupOffset(); showToast('Troca de aba registrada.');
      saveDraft();
    }else{
      focusFlag.textContent='Foco OK';
      if(isBlurred){ totalBlurMs += Date.now()-(blurStart||Date.now()); isBlurred=false; }
    }
  });
  window.addEventListener('blur', ()=>{
    if(!started||ended) return;
    blurCount++; if(document.visibilityState!=='hidden'){ tabSwitches++; tabCountEl.textContent=`Abas: ${tabSwitches}`; maybeApplySystemPopupOffset(); }
    focusFlag.textContent='Focus LOST'; isBlurred=true; blurStart=Date.now(); saveDraft();
  });
  window.addEventListener('focus', ()=>{
    if(!started||ended) return;
    focusFlag.textContent='Foco OK';
    if(isBlurred){ totalBlurMs += Date.now()-(blurStart||Date.now()); isBlurred=false; }
  });
  window.addEventListener('pagehide', ()=>{
    if(!started||ended) return;
    tabSwitches++; tabCountEl.textContent=`Abas: ${tabSwitches}`; maybeApplySystemPopupOffset();
    if(isBlurred){ totalBlurMs += Date.now()-(blurStart||Date.now()); isBlurred=false; }
    saveDraft();
  });

  // ===== Modal / in√≠cio =====
  modalName.addEventListener('input', ()=>{ acceptBtnEl.disabled=!isValidFullName(modalName.value) });
  document.getElementById('acceptBtn').addEventListener('click', async ()=>{
    const fullName=(modalName.value||'').trim().replace(/\s+/g,' ');
    if(!isValidFullName(fullName)){ modalName.setAttribute('aria-invalid','true'); modalName.focus(); return; }

    // preenche o nome antes de iniciar (para draftKey correto)
    document.getElementById('studentName').value=fullName;

    // fecha modal
    const backdrop=document.getElementById('consentBackdrop'); if(backdrop) backdrop.remove();
    document.body.style.overflow='';

    acceptTs=Date.now();
    startTest();
    try{ await goFullscreen(); }catch(e){}

    // s√≥ agora, com nome + testId dispon√≠veis, tenta carregar rascunho do mesmo aluno
    loadDraft();
  });

  document.getElementById('declineBtn').addEventListener('click', ()=>{ window.location.href='about:blank' });

  // bloqueios enquanto modal existe
  document.addEventListener('keydown',(e)=>{
    if(document.getElementById('consentBackdrop')){
      const k=e.key.toLowerCase();
      if((e.ctrlKey||e.metaKey)&&(k==='w'||k==='r'||k==='p'||k==='s'||k==='f')) e.preventDefault();
      if(k==='f11') e.preventDefault();
    }
  });
  document.addEventListener('contextmenu',(e)=> e.preventDefault());
  </script>
</body>
</html>
